name: Daily TCG Scraper

on:
  schedule:
    # LÃ¤uft tÃ¤glich um 0:00 Uhr UTC (1:00 Uhr MEZ im Winter, 2:00 Uhr MESZ im Sommer)
    - cron: '0 0 * * *'
  workflow_dispatch:  # ErmÃ¶glicht manuelles Starten Ã¼ber GitHub UI

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # VollstÃ¤ndige Git-Historie fÃ¼r gh-pages
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml
      
      - name: Run City League Scraper
        continue-on-error: true
        run: |
          echo "================================================"
          echo "Running City League Archetype Scraper..."
          echo "================================================"
          python city_league_archetype_scraper.py
      
      - name: Run Limitless Online Scraper
        continue-on-error: true
        run: |
          echo "================================================"
          echo "Running Limitless Online Scraper..."
          echo "================================================"
          python limitless_online_scraper.py
      
      - name: Run Current Meta Analysis Scraper
        continue-on-error: true
        run: |
          echo "================================================"
          echo "Running Current Meta Analysis Scraper..."
          echo "================================================"
          python current_meta_analysis_scraper.py
      
      - name: Check for Changes
        id: check_changes
        run: |
          git diff --exit-code data/ || echo "changes=true" >> $GITHUB_OUTPUT
          echo "changes=false" >> $GITHUB_OUTPUT
      
      - name: Commit and Push Changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          
          # Aktuelles Datum/Zeit fÃ¼r Commit-Message
          TIMESTAMP=$(date +'%d.%m.%Y %H:%M')
          
          # Stage alle Ã„nderungen in data/
          git add data/
          git add landing.html index.html || true
          
          # Commit mit Timestamp
          git commit -m "ğŸ¤– Automated data update - ${TIMESTAMP}" || exit 0
          
          # Push zu main branch
          git push origin main
          
          echo "âœ… Changes pushed to main branch"
      
      - name: Deploy to GitHub Pages
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          # Checkout gh-pages branch
          git fetch origin gh-pages
          git checkout gh-pages
          
          # Merge main branch changes
          git merge origin/main -m "ğŸš€ Deploy: Sync from main"
          
          # Push to gh-pages
          git push origin gh-pages
          
          echo "âœ… Changes deployed to GitHub Pages"
      
      - name: Summary
        if: always()
        run: |
          echo "================================================"
          echo "ğŸ“Š SCRAPER RUN SUMMARY"
          echo "================================================"
          echo "âœ… All scrapers executed"
          echo "ğŸ“… Run completed at: $(date +'%d.%m.%Y %H:%M:%S')"
          echo ""
          echo "ğŸŒ Website: https://captheavenger.github.io/HausiTCG/"
          echo "================================================"
